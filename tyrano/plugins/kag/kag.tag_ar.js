tyrano.plugin.kag.tag.bgcamera={vital:[],pm:{name:"",wait:"true",time:1e3,fit:"true",width:"",height:"",left:"",top:"",qrcode:"off",debug:"false",mode:"",stop:"false",audio:"false"},start:function(t){this.kag.ftag.hideNextImg();var e=this;this.kag.stat.qr.mode=t.qrcode,0==t.time&&(t.wait="false");var a,i,s=document.createElement("video");(s.id="bgcamera",s.style.backgroundColor="black",s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.width="100%",s.style.display="none",s.autoplay=!0,s.autobuffer=!0,""!=t.width&&(s.style.width=t.width+"px"),""!=t.height)?s.style.height=t.height+"px":"true"==t.fit?parseInt(this.kag.config.scWidth)>parseInt(this.kag.config.scHeight)?(s.style.height="",s.style.width="100%"):(s.style.height="100%",s.style.width=""):s.style.height="";""!=t.left&&(s.style.left=t.left+"px"),""!=t.top&&(s.style.top=t.top+"px"),s.setAttribute("playsinline","1"),"true"==t.mute&&(s.muted=!0),a=s,i=t,s.addEventListener("canplay",function(){g.fadeIn(parseInt(t.time),function(){e.kag.tmp.camera_stream=!0,"true"==t.wait&&"false"==t.stop&&e.kag.ftag.nextOrder(),e.checkPicture(a,i)})});var r={video:!0,audio:!1};"true"==t.audio&&(r.audio=!0);"back"==t.mode?r.video={facingMode:"environment"}:"front"==t.mode&&(r.video={facingMode:"user"});let g=$(s);$.setName(g,t.name),g.css("z-index",1),g.addClass("bgcamera"),this.kag.stat.current_bgcamera=t,$("#tyrano_base").append(g),navigator.mediaDevices.getUserMedia(r).then(t=>{s.srcObject=t,s.onloadedmetadata=(t=>{})}),"false"==t.wait&&"false"==t.stop&&e.kag.ftag.nextOrder()},checkPicture:function(t,e){if(0==this.kag.tmp.camera_stream)return;if("off"==this.kag.stat.qr.mode||1!=this.kag.stat.is_strong_stop)return void setTimeout(()=>{this.checkPicture(t,e)},1e3);var a=parseInt(this.kag.config.scWidth)/4,i=parseInt(this.kag.config.scHeight)/4,s=document.createElement("canvas");s.width=a,s.height=i;var r=s.getContext("2d");r.drawImage(t,0,0,s.width,s.height);const g=r.getImageData(0,0,s.width,s.height),o=jsQR(g.data,s.width,s.height);var n=this.kag.stat.qr.mode;if(o){var h=o.data;if("true"==e.debug&&alert(h),-1!=h.indexOf("http")){if("all"==n||"define"==n||"web"==n)if(this.kag.stat.qr.define[h]){var d=this.kag.stat.qr.define[h];1==this.kag.stat.is_strong_stop&&(this.kag.layer.showEventLayer(),this.kag.ftag.startTag("jump",d))}else"define"!=n&&(location.href=h)}else if(-1!=h.indexOf("tyrano:")){if("all"==n||"jump"==n){var f=$.replaceAll(h,"tyrano://",""),c=$.getUrlQuery(f);d={};c.storage&&(d.storage=c.storage),c.target&&(d.target=c.target),this.kag.stat.qr.mode="off",1==this.kag.stat.is_strong_stop&&(this.kag.layer.showEventLayer(),this.kag.ftag.startTag("jump",d))}}else if(-1!=h.indexOf("[jump")&&("all"==n||"jump"==n)){d=this.kag.parser.makeTag(h).pm;this.kag.stat.qr.mode="off",1==this.kag.stat.is_strong_stop&&(this.kag.layer.showEventLayer(),this.kag.ftag.startTag("jump",d))}setTimeout(()=>{this.checkPicture(t,e)},300)}else setTimeout(()=>{this.checkPicture(t,e)},300)}},tyrano.plugin.kag.tag.qr_config={vital:[],pm:{qrcode:""},start:function(t){""!=t.qrcode&&(this.kag.stat.qr.mode=t.qrcode),this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag.stop_bgcamera={vital:[],pm:{time:"1000",wait:"true"},start:function(t){var e=this;e.kag.tmp.camera_stream=!1,$(".tyrano_base").find("#bgcamera").fadeOut(parseInt(t.time),function(){$(this)[0].srcObject.getVideoTracks().forEach(t=>{t.stop()}),$(this)[0].srcObject.getAudioTracks().forEach(t=>{t.stop()}),$(this).remove(),"true"==t.wait&&e.kag.ftag.nextOrder()}),$(".tyrano_base").find("#bgcamera").get(0)?("false"==t.wait&&e.kag.ftag.nextOrder(),this.kag.stat.current_bgcamera=""):e.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag.qr_define={vital:["url"],pm:{url:"",storage:"",target:"",clear:"false"},start:function(t){"true"==t.clear?delete this.kag.stat.qr.define[t.url]:this.kag.stat.qr.define[t.url]=t,this.kag.ftag.nextOrder()}};
